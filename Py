import requests
import xml.etree.ElementTree as ET

# ======= CONFIGURATION ========
SPLUNK_AUTH_URL = "https://splunk-rest.ops.tiaa-cref.org/services/auth/login"
BASE_REST_URL = "https://splunk-rest.ops.tiaa-cref.org/services"
USERNAME = "kalajo"
PASSWORD = "Qwer"
VERIFY_SSL = False
# ==============================

# Default basic search if no valid search ID found
BASIC_SEARCH = "| makeresults count=1 | fields - _*"

# Disable SSL warnings if needed
if not VERIFY_SSL:
    requests.packages.urllib3.disable_warnings()

def get_session_key():
    """Authenticate and return session key"""
    try:
        response = requests.post(
            SPLUNK_AUTH_URL,
            data={"username": USERNAME, "password": PASSWORD},
            verify=VERIFY_SSL
        )
        response.raise_for_status()
        root = ET.fromstring(response.content)
        return root.find('.//sessionKey').text
    except Exception as e:
        print(f"Authentication failed: {str(e)}")
        exit(1)

def try_search_endpoints(session_key):
    """Attempt different search endpoints with fallback"""
    endpoints = [
        f"{BASE_REST_URL}/search/jobs",  # Standard endpoint
        f"{BASE_REST_URL}NS/{USERNAME}/search/search/jobs"  # Namespaced endpoint
    ]
    
    for endpoint in endpoints:
        try:
            response = requests.post(
                endpoint,
                headers={
                    "Authorization": f"Splunk {session_key}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                data={"search": BASIC_SEARCH, "output_mode": "csv"},
                verify=VERIFY_SSL
            )
            response.raise_for_status()
            
            # Try to parse search ID
            root = ET.fromstring(response.content)
            search_id = root.find('.//sid').text
            print(f"Success using endpoint: {endpoint}")
            return search_id
            
        except Exception as e:
            print(f"Attempt failed for {endpoint}: {str(e)}")
            continue
            
    return None

def main():
    # Get authenticated session
    session_key = get_session_key()
    print(f"Obtained session key: {session_key[:15]}...")

    # Attempt search creation
    search_id = try_search_endpoints(session_key)
    
    if not search_id:
        print("\nAll search attempts failed. Potential issues:")
        print("1. Incorrect REST API endpoints")
        print("2. Missing search permissions for user")
        print("3. Network/firewall restrictions")
        print("4. Invalid session key")
        exit(1)
        
    print(f"\nSearch job created successfully! ID: {search_id}")
    
    # Add results retrieval logic here
    # ...

if __name__ == "__main__":
    main()
