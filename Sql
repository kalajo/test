

WITH ces_data AS (
    SELECT 
        cer.id AS cer_id,
        ce.id AS ce_id,
        pce.id AS pce_id,
        pce.orchestration_id,
        pce.plan_number,
        ma.id AS mailing_id,
        ma.notice_send_date,
        mcf.ccp_file_name,
        mad.adhocpdf_dri,
        pds.plan_name,
        pds.client_id
    FROM 
        CES01.change_event_request cer
        JOIN CES01.change_event ce ON ce.change_event_request_id = cer.id
        JOIN CES01.plan_change_event pce ON pce.change_event_id = ce.id
        LEFT JOIN CES01.mailing ma ON ma.plan_change_event_id = pce.id
        LEFT JOIN CES01.mailing_ccp_files mcf ON mcf.mailing_id = ma.id
        LEFT JOIN CES01.mailing_detail mad ON mad.mailing_id = ma.id
        LEFT JOIN CES01.prism_data_staging pds 
            ON pds.client_id = ce.client_id 
            AND pds.plan_id = pce.plan_number
    WHERE 
        pce.orchestration_id IN ('PLIAFS45LG3')
)
SELECT 
    cd.plan_name,
    COALESCE(p.id, 0) AS package_id,
    COALESCE(p.universal_id, 'No PIN') AS pin,
    COALESCE(TO_CHAR(p.created_ts, 'DD-MON-YYYY'), 'No Date') AS communication_date,
    COALESCE(doc.description, 'No Delivery Method') AS delivery_method
FROM 
    ces_data cd
    LEFT JOIN CCP01.event_batch eb ON eb.batch_identifier = cd.ccp_file_name
    LEFT JOIN CCP01.packages p ON p.input_batch_id = eb.id 
        AND p.package_type_id IS NOT NULL
        AND p.created_ts > cd.notice_send_date
        AND EXTRACTVALUE(
            XMLTYPE(p.package_data),
            '/DocumentRequest/DocumentInfoXml/AdhocMailingRequest/AdhocPDFDRI'
        ) = cd.adhocpdf_dri
    LEFT JOIN CCP01.delivery_output_channel doc ON doc.id = p.delivery_output_channel_id
WHERE
    (p.delivery_output_channel_id IN (1, 3) OR p.delivery_output_channel_id IS NULL);








WITH ces_data AS (
    SELECT 
        cer.id AS cer_id,
        ce.id AS ce_id,
        pce.id AS pce_id,
        pce.orchestration_id,
        pce.plan_number,
        ma.id AS mailing_id,
        ma.notice_send_date,
        mcf.ccp_file_name,
        mad.adhocpdf_dri,
        pds.plan_name,
        pds.client_id
    FROM 
        CES01.change_event_request cer
        JOIN CES01.change_event ce ON ce.change_event_request_id = cer.id
        JOIN CES01.plan_change_event pce ON pce.change_event_id = ce.id
        LEFT JOIN CES01.mailing ma ON ma.plan_change_event_id = pce.id
        LEFT JOIN CES01.mailing_ccp_files mcf ON mcf.mailing_id = ma.id
        LEFT JOIN CES01.mailing_detail mad ON mad.mailing_id = ma.id
        LEFT JOIN CES01.prism_data_staging pds 
            ON pds.client_id = ce.client_id 
            AND pds.plan_id = pce.plan_number
    WHERE 
        pce.orchestration_id IN ('PLIAFS45LG3')
)
SELECT 
    cd.plan_name,
    COALESCE(p.id, 0) AS package_id,
    COALESCE(p.universal_id, 'No PIN') AS pin,
    COALESCE(TO_CHAR(p.created_ts, 'DD-MON-YYYY'), 'No Date') AS communication_date,
    COALESCE(doc.description, 'No Delivery Method') AS delivery_method,
    NVL(xt.element1, 0) AS xml_element1,
    NVL(xt.element2, 'N/A') AS xml_element2,
    NVL(xt.element3, 0) AS xml_element3
FROM 
    ces_data cd
    LEFT JOIN CCP01.event_batch eb ON eb.batch_identifier = cd.ccp_file_name
    LEFT JOIN CCP01.packages p ON p.input_batch_id = eb.id 
        AND p.package_type_id IS NOT NULL
        AND p.created_ts > cd.notice_send_date
        AND EXTRACTVALUE(
            XMLTYPE(p.package_data),
            '/DocumentRequest/DocumentInfoXml/AdhocMailingRequest/AdhocPDFDRI'
        ) = cd.adhocpdf_dri
    LEFT JOIN CCP01.delivery_output_channel doc ON doc.id = p.delivery_output_channel_id
    OUTER APPLY (
        SELECT 
            xt.*
        FROM 
            XMLTABLE(
                '/DocumentRequest/DocumentInfoXml'
                PASSING XMLTYPE(p.package_data)
                COLUMNS
                    element1 NUMBER PATH 'Element1',
                    element2 VARCHAR2(100) PATH 'Element2',
                    element3 NUMBER PATH 'Element3'
            ) xt
    ) xt
WHERE
    (p.delivery_output_channel_id IN (1, 3) OR p.delivery_output_channel_id IS NULL);


